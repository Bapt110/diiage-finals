# Global settings
global:
  namespace: monitoring

cert-manager:
  enabled: true
  installCRDs: true

opentelemetry-operator:
  enabled: true
  manager:
    autoInstrumentation:
      go:
        enabled: true
    autoInstrumentationImage:
      go:
        repository: ghcr.io/open-telemetry/opentelemetry-go-instrumentation/autoinstrumentation-go
        tag: v0.23.0

# OpenTelemetry Collector CRD
opentelemetryCollector:
  enabled: true
  name: monitoring-collector
  image: otel/opentelemetry-collector-contrib:latest
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 256Mi
  exporters:
    tempoEndpoint: diiage-monitoring-tempo.monitoring.svc.cluster.local:4317
    prometheusEndpoint: http://diiage-monitoring-prometheus-server.monitoring.svc.cluster.local:80/api/v1/write

# Prometheus configuration
prometheus:
  enabled: true
  alertmanager:
    enabled: false
  prometheus-pushgateway:
    enabled: false
  kube-state-metrics:
    enabled: true
  prometheus-node-exporter:
    enabled: true
  
  server:
    resources:
      requests:
        cpu: 100m
        memory: 512Mi
      limits:
        cpu: 500m
        memory: 1Gi
    retention: "7d"
    extraArgs:
      web.enable-remote-write-receiver: ""
    service:
      type: ClusterIP
      servicePort: 80
    persistentVolume:
      enabled: false
    emptyDir:
      sizeLimit: ""
  
  # Scrape Configs
  serverFiles:
    prometheus.yml:
      scrape_configs:
        - job_name: 'otel-collector'
          static_configs:
            # Nom DNS correct (celui de l'opérateur)
            - targets: ['monitoring-collector-collector.monitoring.svc.cluster.local:8888']
        
        - job_name: 'backend'
          kubernetes_sd_configs:
            - role: pod
          relabel_configs:
            - source_labels: [__meta_kubernetes_pod_label_app]
              regex: diiage-finals-app.*backend
              action: keep
            - source_labels: [__meta_kubernetes_pod_ip]
              target_label: __address__
              action: replace
              regex: '(.+)'
              replacement: '$1:8080'
  
  persistence:
    enabled: false

# Tempo configuration
tempo:
  enabled: true
  replicas: 1
  tempo:
    repository: grafana/tempo
    tag: 2.3.1
    pullPolicy: IfNotPresent
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 1Gi
    storage:
      trace:
        backend: local
        local:
          path: /tmp/tempo/traces
        wal:
          path: /tmp/tempo/wal
    ingester:
      max_block_duration: 5m
    compactor:
      compaction:
        block_retention: 48h
    server:
      http_listen_port: 3200
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
  
  # Ports Service Tempo (Critique)
  service:
    type: ClusterIP
    ports:
      - name: http
        port: 3200
        targetPort: 3200
        protocol: TCP
      - name: otlp-grpc
        port: 4317
        targetPort: 4317
        protocol: TCP
      - name: otlp-http
        port: 4318
        targetPort: 4318
        protocol: TCP

  persistence:
    enabled: false
  securityContext:
    runAsUser: 10001
    runAsGroup: 10001
    fsGroup: 10001
    runAsNonRoot: true

# Grafana configuration
grafana:
  enabled: true
  adminUser: admin
  adminPassword: admin
  service:
    type: ClusterIP
    port: 80
  persistence:
    enabled: true
    type: pvc
    accessModes:
      - ReadWriteOnce
    size: 10Gi
    annotations: {}
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi
  grafana.ini:
    server:
      root_url: "%(protocol)s://%(domain)s:%(http_port)s/"
    auth:
      disable_login_form: false
      anonymous:
        enabled: true
        org_role: Viewer
  
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          access: proxy
          url: http://diiage-monitoring-prometheus-server:80
          isDefault: true
          editable: true
          jsonData:
            timeInterval: 15s
        
        - name: Tempo
          type: tempo
          access: proxy
          url: http://diiage-monitoring-tempo:3200
          isDefault: false
          editable: true
          jsonData:
            httpMethod: GET
            serviceMap:
              datasourceUid: Prometheus
            nodeGraph:
              enabled: true
        
        - name: Tempo (Search)
          type: tempo
          access: proxy
          url: http://diiage-monitoring-tempo:3200
          isDefault: false
          editable: true
          jsonData:
            httpMethod: GET
            search:
              hide: false
            nodeGraph:
              enabled: true
            serviceMap:
              datasourceUid: Prometheus
  
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: 'default'
          orgId: 1
          folder: ''
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards/default
  
  # Dashboards retirés temporairement pour validation syntaxique
  dashboards: {}
